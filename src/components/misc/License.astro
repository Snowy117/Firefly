---
import { Icon } from "astro-icon/components";
import { licenseConfig } from "@/config/licenseConfig";
import { profileConfig } from "@/config/profileConfig";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { formatDateToYYYYMMDD } from "@/utils/date-utils";

interface Props {
	title: string;
	id: string;
	pubDate: Date;
	editDate?: Date;
	class: string;
	author: string;
	sourceLink: string;
	licenseName: string;
	licenseUrl: string;
}

const {
	title,
	pubDate,
	editDate,
	author,
	sourceLink,
	licenseName,
	licenseUrl,
} = Astro.props;
const className = Astro.props.class;
const profileConf = profileConfig;
const licenseConf = licenseConfig;
const postUrl = sourceLink || decodeURIComponent(Astro.url.toString());
---

<div
  class={`relative transition overflow-hidden bg-[var(--license-block-bg)] py-5 px-6 ${className}`}
>
  <div class="transition font-bold text-black/75 dark:text-white/75">
    {title}
  </div>
  <div class="flex items-center gap-2">
    <div class="copy-url-btn group cursor-pointer transition text-[var(--primary)] flex items-center gap-2" data-url={postUrl}>
      <div class="relative w-4 h-4 flex items-center justify-center">
        <Icon name="fa6-regular:copy" class="icon-copy absolute transition-all scale-100" />
        <Icon name="fa6-solid:check" class="icon-check absolute transition-all scale-0 opacity-0" />
      </div>
      <div class="link text-[var(--primary)] transition-colors group-hover:text-[var(--primary)]/75">{postUrl}</div>
    </div>
  </div>
  <div class="flex gap-6 mt-2">
    <div>
      <div class="transition text-black/30 dark:text-white/30 text-sm">
        {i18n(I18nKey.author)}
      </div>
      <div class="transition text-black/75 dark:text-white/75 line-clamp-2">
        {author || profileConf.name}
      </div>
    </div>
    <div>
      <div class="transition text-black/30 dark:text-white/30 text-sm">
        {i18n(I18nKey.publishedAt)}
      </div>
      <div class="transition text-black/75 dark:text-white/75 line-clamp-2">
        {formatDateToYYYYMMDD(pubDate)}
      </div>
    </div>
    {editDate && (
      <div>
        <div class="transition text-black/30 dark:text-white/30 text-sm">
          {i18n(I18nKey.updatedAt)}
        </div>
        <div class="transition text-black/75 dark:text-white/75 line-clamp-2">
          {formatDateToYYYYMMDD(editDate)}
        </div>
      </div>
    )}
    <div>
      <div class="transition text-black/30 dark:text-white/30 text-sm">
        {i18n(I18nKey.license)}
      </div>
      <a
        href={licenseName ? licenseUrl || undefined : licenseConf.url}
        target="_blank"
        class="link text-[var(--primary)] line-clamp-2"
        >{licenseName || licenseConf.name}</a
      >
    </div>
  </div>
  <Icon
    name="fa6-brands:creative-commons"
    class="transition text-[15rem] absolute pointer-events-none right-6 top-1/2 -translate-y-1/2 text-black/5 dark:text-white/5"
  />
</div>

<script>
  function initCopyUrl() {
    const btns = document.querySelectorAll('.copy-url-btn');
    for (const btn of btns) {
      btn.addEventListener('click', async (e) => {
        const url = btn.getAttribute('data-url');
        const copyIcon = btn.querySelector('.icon-copy');
        const checkIcon = btn.querySelector('.icon-check');

        if (url) {
          try {
            await navigator.clipboard.writeText(url);
            if (copyIcon && checkIcon) {
                copyIcon.classList.add('scale-0', 'opacity-0');
                checkIcon.classList.remove('scale-0', 'opacity-0');
                setTimeout(() => {
                    copyIcon.classList.remove('scale-0', 'opacity-0');
                    checkIcon.classList.add('scale-0', 'opacity-0');
                }, 1000);
            }
          } catch (err) {
            console.error('Failed to copy: ', err);
          }
        }
      });
    }
  }
  initCopyUrl();
  document.addEventListener('astro:after-swap', initCopyUrl);
</script>
